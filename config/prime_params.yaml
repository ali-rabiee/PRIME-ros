# PRIME System Parameters

# Robot configuration
robot:
  type: "j2n6s300"  # Kinova Jaco2 6-DOF
  driver_prefix: "/j2n6s300_driver"

# Workspace — defines the 3x3 grid and where grid cells map in the robot frame.
# Grid cell centers (A1..C3) are derived from this rectangle.
# This can differ from safety_bounds (e.g. workspace is a subset of the safe region).
workspace:
  frame_id: "root"
  grid_rows: 3
  grid_cols: 3
  # Metric rectangle for the 3x3 grid (in frame_id coordinates)
  x_min: -0.33
  x_max: 0.33
  y_min: -0.70
  y_max: -0.33
  # Constant object Z (table height in root frame). APPROACH adds pre_grasp_distance on top.
  object_z: 0.36
  # Flip grid-to-metric mapping direction without changing the rectangle itself.
  # [-1, 1, 1] = flip left/right (A1<->A3), [1,-1,1] = flip top/bottom (A*<->C*), [-1,-1,1] = both
  axis_signs: [-1.0, 1.0, 1.0]
  # Optional constant yaw offset (radians) applied when converting mask yaw (image space)
  # into robot/world yaw for ALIGN_YAW. Tune this if yaw appears consistently rotated.
  yaw_offset_rad: 0.0

# Safety boundary — hard motion limits (recommended ON for real robot)
# MoveIt tool calls are clamped to these bounds. Can be wider than workspace.
safety_bounds:
  enabled: true
  frame_id: "root"
  x_min: -0.26
  x_max: 0.33
  y_min: -0.7
  y_max: -0.33
  z_min: 0.20
  z_max: 0.60
  outer_extent: 2.0
  add_moveit_walls: false
  wall_thickness: 0.02

# State builder parameters
state_builder:
  gripper_history_length: 10  # Number of timesteps to keep
  gui_event_history_length: 20
  update_rate: 10.0  # Hz
  position_threshold: 0.02  # meters, minimum movement to update history
  # Detection class filtering for modern YOLO label sets:
  # - "*" accepts all detected classes as object candidates
  # - ignored_detection_classes are excluded from PRIME suggestions
  object_classes: ["*"]
  ignored_detection_classes: ["workspace", "jaco"]
  # If true, use YOLO mask-based yaw (det["mask_yaw_rad"]) for ObjectState.yaw_orientation.
  # This is purely image-based and only reliable for elongated silhouettes.
  use_mask_yaw: true
  mask_yaw_field: "mask_yaw_rad"
  # Publish /prime/yaw_debug image with arrows showing each object's believed yaw
  publish_yaw_debug: true
  # Stabilization for YOLO detections -> PRIME objects
  min_object_confidence: 0.5
  # If publish_stale_tracks=false, tracks not seen for track_max_age seconds won't be published.
  track_max_age: 1.0            # seconds
  track_max_pixel_dist: 80.0    # pixels (matching radius for tracking)
  track_smoothing_alpha: 0.35   # 0..1 (EMA smoothing on position/centroid)
  # Keep object IDs stable through occlusions (recommended when objects are static during an episode)
  persist_tracks: true
  publish_stale_tracks: true
  forget_tracks_after: 30.0     # seconds; 0.0 = never forget
  # Do not create permanent objects from one-frame false positives
  track_min_confirmations: 3    # detections before an object becomes "real"
  track_tentative_ttl: 2.0      # seconds allowed to reach confirmations
  publish_tentative_tracks: false

# Candidate selection parameters
candidates:
  # Nearby threshold for candidate initialization
  neighbor_threshold: 1  # grid cells
  # Motion direction threshold for candidate inclusion
  direction_threshold: 0.3  # radians

# LLM configuration
llm:
  model: "qwen2.5"
  endpoint: "http://localhost:11434/api/generate"  # Ollama default
  temperature: 0.3
  max_tokens: 500
  timeout: 30.0  # seconds

# User interface configuration
ui:
  query_timeout: 30.0  # seconds

# GUI teleoperation configuration
teleop_gui:
  # Kinova cartesian velocity control is designed around a ~100Hz command loop.
  # Lower rates can lead to very weak/choppy motion.
  publish_rate: 100.0
  # Translation velocity in m/s. Increase if translation feels too slow.
  linear_speed: 0.25
  angular_speed: 5.0
  gripper_activity_latch: 0.2

# Tool execution parameters
tools:
  approach:
    pre_grasp_distance: 0.10  # meters above object
    approach_speed: 0.1  # m/s
    # Pixel-servo refinement (after reaching grid-cell center)
    pixel_servo:
      # Opt-in: enable only when you explicitly want vision servoing
      enabled: false
      max_steps: 8
      pixel_tolerance: 15          # stop if |pixel error| <= this
      gain: 0.6                    # scales commanded XY step
      max_step_m: 0.03             # clamp each servo move to this (meters) — 3cm per step
      probe_step_m: 0.05           # small move used to estimate pixel Jacobian (meters) — 5cm probe
      settle_time_s: 0.50          # wait after each move for arm to settle (fresh YOLO is also awaited separately)
      missing_object_stop_frames: 2  # if target object isn't detected for N cycles, stop (assume occluded)
  align:
    tolerance: 0.1  # radians
    # If true, add 90° to the object major-axis yaw so gripper fingers cross the
    # narrow dimension (usually better for stable grasps on elongated objects).
    perpendicular: true
    # Extra constant offset (radians) applied on top of object yaw during ALIGN_YAW.
    # Use to fine-tune alignment calibration.
    extra_yaw_offset: 0.0
    # Velocity / acceleration scaling during ALIGN_YAW (0.0-1.0).
    # Lower = slower, gentler motion.  0.4 avoids red-light joint-limit warnings.
    velocity_scaling: 0.4
    acceleration_scaling: 0.4
    # Extra clearance (m) above object beyond pre_grasp_distance for ALIGN_YAW.
    # Increase if the arm still reaches near z-limits while rotating.
    extra_clearance: 0.0
    # Safe wrist-joint (joint 6) range in radians. Wrist values are wrapped into
    # [-wrist_limit, +wrist_limit] to prevent Kinova hardware faults.
    wrist_limit: 5.0
  grasp:
    finger_close_position: 5000  # Kinova units (0-6800)
    finger_open_position: 0

# Memory configuration
memory:
  max_dialog_history: 20
  max_tool_history: 10

# Topics
topics:
  camera_color: "/camera/color/image_raw"
  camera_depth: "/camera/aligned_depth_to_color/image_raw"
  yolo_detections: "/yolo/image_with_bboxes"
  tool_pose: "/j2n6s300_driver/out/tool_pose"
  finger_position: "/j2n6s300_driver/out/finger_position"
  joint_state: "/j2n6s300_driver/out/joint_state"
