<?xml version="1.0"?>
<launch>
  <!-- AprilTag placement test (Option A prerequisite) -->

  <!-- Tag definition -->
  <arg name="tag_id" default="0"/>
  <!-- Tag black square edge length in meters (border between black/white) -->
  <arg name="tag_size" default="0.18"/>

  <!-- Camera topics (RealSense defaults) -->
  <arg name="camera_name" default="/camera/color"/>
  <arg name="image_topic" default="image_raw"/>

  <!-- RealSense color stream tuning for long-range tag detection -->
  <!-- At ~1.5m, 640x480 can be borderline; 1280x720 is much more reliable. -->
  <arg name="color_width" default="1280"/>
  <arg name="color_height" default="720"/>
  <arg name="color_fps" default="30"/>

  <!-- Detector node name -->
  <arg name="node_name" default="apriltag_ros_continuous_node"/>

  <!-- Start RealSense camera -->
  <include file="$(find realsense2_camera)/launch/rs_camera.launch">
    <!-- Keep defaults; you can override via roslaunch args if needed -->
    <arg name="align_depth" value="true"/>
    <arg name="color_width" value="$(arg color_width)"/>
    <arg name="color_height" value="$(arg color_height)"/>
    <arg name="color_fps" value="$(arg color_fps)"/>
  </include>

  <!-- AprilTag continuous detector -->
  <!-- We avoid the apriltag_ros provided launch so we can inline tag ID/size. -->
  <node pkg="apriltag_ros" type="apriltag_ros_continuous_node" name="$(arg node_name)"
        clear_params="true" output="screen">

    <!-- Core detector settings -->
    <!-- NOTE: these are private params (~tag_family, ~publish_tf, etc.) -->
    <rosparam>
      tag_family: 'tag36h11'
      tag_threads: 4
      tag_decimate: 1.0
      tag_blur: 0.0
      tag_refine_edges: 1
      tag_debug: 0
      max_hamming_dist: 2
      publish_tf: true
      transport_hint: 'raw'
    </rosparam>

    <!-- Tag(s) to estimate pose for -->
    <!-- NOTE: size is in meters and must match printed tag (black square edge). -->
    <rosparam subst_value="true">
      standalone_tags:
        [
          {id: $(arg tag_id), size: $(arg tag_size), name: workspace_tag}
        ]
    </rosparam>

    <!-- Publish overlay image -->
    <param name="publish_tag_detections_image" type="bool" value="true" />

    <!-- Remap to RealSense color streams -->
    <remap from="image_rect" to="$(arg camera_name)/$(arg image_topic)" />
    <remap from="camera_info" to="$(arg camera_name)/camera_info" />
  </node>
</launch>

